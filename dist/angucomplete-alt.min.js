/*! Copyright (c) 2014 Hidenari Nozaki and contributors | Licensed under the MIT license */
"use strict";!function(e,t){"undefined"!=typeof module&&module.exports?module.exports=t(require("angular")):"function"==typeof define&&define.amd?define(["angular"],t):t(e.angular)}(window,function(e){e.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$parse","$http","$sce","$timeout","$templateCache",function(e,t,n,r,l,i){var o=40,s=39,a=38,c=37,u=27,d=13,g=9,h=3,p=524288,f=500,m=200,v="autocomplete-required",S="Searching...",w="No results found",x="/angucomplete-alt/index.html";return i.put(x,'<div class="angucomplete-holder" ng-class="{\'angucomplete-dropdown-visible\': showDropdown}">  <input id="{{id}}_value" name={{inputName}} ng-class="{\'angucomplete-input-not-empty\': notEmpty}" ng-model="searchStr" ng-disabled="disableInput" type="{{inputType}}" placeholder="{{placeholder}}" maxlength="{{maxlength}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"/>  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-show="showDropdown">    <div class="angucomplete-searching" ng-if="!hideTextSearching" ng-show="searching" ng-bind="textSearching"></div>    <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>    <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseenter="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">      <div ng-if="imageField" class="angucomplete-image-holder">        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>      </div>      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>    </div>  </div></div>'),{restrict:"EA",require:"^?form",scope:{selectedObject:"=",disableInput:"=",initialValue:"=",localData:"=",remoteUrlRequestFormatter:"=",remoteUrlRequestWithCredentials:"@",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",remoteApiHandler:"=",id:"@",type:"@",placeholder:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"@",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&",inputName:"@",searchStr:"@",hideWhileSearching:"=",highlightExactMatch:"=",hideTextSearching:"=",hideNoResults:"="},templateUrl:function(e,t){return t.templateUrl||x},link:function(t,i,x,C){function R(e){he=null,t.hideResults(e),document.body.removeEventListener("click",R)}function y(e){return e.which?e.which:e.keyCode}function I(e){"function"==typeof t.selectedObject?t.selectedObject(e):t.selectedObject=e,O(e?!0:!1)}function b(e){return function(n){return t[e]?t[e](n):n}}function D(e){I({originalObject:e}),t.clearSelected&&(t.searchStr=null),z()}function $(e){return t.titleField.split(",").map(function(t){return F(e,t)}).join(" ")}function F(e,t){var n,r;if(t){n=t.split("."),r=e;for(var l=0;l<n.length;l++)r=r[n[l]]}else r=e;return r}function q(e,n){var l,i,o;return o=new RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i"),e?(e.match&&e.replace||(e=e.toString()),i=e.match(o),l=i?e.replace(o,'<span class="'+t.matchClass+'">'+i[0]+"</span>"):e,r.trustAsHtml(l)):void 0}function O(e){t.notEmpty=e,ce=t.searchStr,t.fieldRequired&&C&&C.$setValidity(ae,e)}function U(e){var n=y(e);if(n!==c&&n!==s)if(n===a||n===d)e.preventDefault();else if(n===o)e.preventDefault(),!t.showDropdown&&t.searchStr&&t.searchStr.length>=oe&&(Y(),t.searching=!0,K(t.searchStr));else if(n===u)z(),ie&&t.$apply(function(){le.val(t.searchStr)});else{if(0===oe&&!t.searchStr)return;t.searchStr&&""!==t.searchStr||(t.showDropdown=!1),ce&&ce!==t.searchStr&&!t.clearSelected&&t.$apply(function(){I()})}}function H(e){!t.overrideSuggestions||t.selectedObject&&t.selectedObject.originalObject===t.searchStr||(e&&e.preventDefault(),D(t.searchStr))}function j(e){var t=getComputedStyle(e);return e.offsetHeight+parseInt(t.marginTop,10)+parseInt(t.marginBottom,10)}function k(){return de.getBoundingClientRect().top+parseInt(getComputedStyle(de).maxHeight,10)}function N(){return i[0].querySelectorAll(".angucomplete-row")[t.currentIndex]}function E(){return N().getBoundingClientRect().top-(de.getBoundingClientRect().top+parseInt(getComputedStyle(de).paddingTop,10))}function T(e){de.scrollTop=de.scrollTop+e}function A(){var e=t.results[t.currentIndex];t.matchClass?le.val($(e.originalObject)):le.val(e.title)}function L(e){var n=y(e),r=null,l=null;n===d&&t.results?(t.currentIndex>=0&&t.currentIndex<t.results.length?(e.preventDefault(),t.selectResult(t.results[t.currentIndex])):(H(e),z()),t.$apply()):n===o&&t.results?(e.preventDefault(),t.currentIndex+1<t.results.length&&t.showDropdown&&(t.$apply(function(){t.currentIndex++,ie&&A()}),ge&&(r=N(),k()<r.getBoundingClientRect().bottom&&T(j(r))))):n===a&&t.results?(e.preventDefault(),t.currentIndex>=1?(t.$apply(function(){t.currentIndex--,ie&&A()}),ge&&(l=E(),0>l&&T(l-1))):0===t.currentIndex&&t.$apply(function(){t.currentIndex=-1,ie&&le.val(t.searchStr)})):n===g&&(t.results&&t.results.length>0&&t.showDropdown?-1===t.currentIndex&&t.overrideSuggestions?H():(-1===t.currentIndex&&(t.currentIndex=0),t.selectResult(t.results[t.currentIndex]),t.$digest()):t.searchStr&&t.searchStr.length>0&&H())}function B(e){return function(n,r,l,i){r||l||i||(n=n.data),t.searching=!1,P(F(Z(n),t.remoteUrlDataField),e)}}function M(e,n,r,l){n||r||l||(n=e.status),0!==n&&(t.remoteUrlErrorCallback?t.remoteUrlErrorCallback(e,n,r,l):console&&console.error&&console.error("http error"))}function V(){ue&&ue.resolve()}function W(r){var l={},i=t.remoteUrl+encodeURIComponent(r);t.remoteUrlRequestFormatter&&(l={params:t.remoteUrlRequestFormatter(r)},i=t.remoteUrl),t.remoteUrlRequestWithCredentials&&(l.withCredentials=!0),V(),ue=e.defer(),l.timeout=ue.promise,n.get(i,l).success(B(r)).error(M)}function _(n){V(),ue=e.defer(),t.remoteApiHandler(n,ue.promise).then(B(n))["catch"](M)}function z(){t.showDropdown=!1,t.results=[],de&&(de.scrollTop=0)}function Y(){t.showDropdown=!t.hideWhileSearching||!(t.hideNoResults&&t.results&&0===t.results.length),t.currentIndex=-1}function G(e){var n,r,l,i,o=t.searchFields.split(","),s=[];for(n=0;n<t.localData.length;n++){for(r=!1,l=0;l<o.length;l++)i=F(t.localData[n],o[l])||"",r=r||i.toString().toLowerCase().indexOf(e.toString().toLowerCase())>=0;r&&(s[s.length]=t.localData[n])}t.searching=!1,P(s,e)}function J(e,t,n){var r=!1;if(n)for(var l in t)t[l].toLowerCase()===n.toLowerCase()&&(r=!0);return r}function K(e){return!e||e.length<oe?void(t.results=[]):void(t.localData?t.$apply(function(){G(e)}):t.remoteApiHandler?_(e):W(e))}function P(e,n){var r,l,i,o,s,a;if(e&&e.length>0){for(t.results=[],r=0;r<e.length;r++)if(t.titleField&&""!==t.titleField&&(o=s=$(e[r])),l="",t.descriptionField&&(l=a=F(e[r],t.descriptionField)),i="",t.imageField&&(i=F(e[r],t.imageField)),t.matchClass&&(s=q(o,n),a=q(l,n)),t.results[t.results.length]={title:s,description:a,image:i,originalObject:e[r]},t.autoMatch||t.highlightExactMatch){var c=t.results.length-1,u=t.results[c],d=J(u,{title:o,desc:l||""},t.searchStr);d&&(t.autoMatch?t.selectResult(u):t.currentIndex=c)}0===t.results.length&&t.hideNoResults?t.showDropdown=!1:t.showDropdown=!0}else t.results=[],t.hideNoResults&&(t.showDropdown=!1)}function Q(){t.localData?P(t.localData,""):t.remoteApiHandler?_(""):W("")}var X,Z,ee,te,ne,re,le=i.find("input"),ie=le.length>0,oe=h,se=null,ae=v,ce=null,ue=null,de=i[0].querySelector(".angucomplete-dropdown"),ge=!1,he=null;re=i.on("mousedown",function(e){e.target.id?(he=e.target.id,he===t.id+"_dropdown"&&document.body.addEventListener("click",R)):he=e.target.className}),t.currentIndex=null,t.searching=!1,ee=t.$watch("initialValue",function(e,n){e&&(ee(),"object"==typeof e?(t.searchStr=$(e),I({originalObject:e})):"string"==typeof e&&e.length>0?t.searchStr=e:console&&console.error&&console.error("Tried to set initial value of angucomplete to",e,"which is an invalid value"),O(!0))}),t.$on("angucomplete-alt:clearInput",function(e,n){n&&n!==t.id||(t.searchStr=null,I(),O(!1),z())}),t.onFocusHandler=function(){t.focusIn&&t.focusIn(),0!==oe||t.searchStr&&0!==t.searchStr.length||(t.showDropdown=!0,Q())},t.hideResults=function(e){he&&(he===t.id+"_dropdown"||he.indexOf("angucomplete")>=0)?he=null:(X=l(function(){z(),t.$apply(function(){t.searchStr&&t.searchStr.length>0&&le.val(t.searchStr)})},m),V(),t.focusOut&&t.focusOut(),t.overrideSuggestions&&t.searchStr&&t.searchStr.length>0&&-1===t.currentIndex&&H())},t.resetHideResults=function(){X&&l.cancel(X)},t.hoverRow=function(e){t.currentIndex=e},t.selectResult=function(e){t.matchClass&&(e.title=$(e.originalObject),e.description=F(e.originalObject,t.descriptionField)),t.clearSelected?t.searchStr=null:t.searchStr=e.title,I(e),z()},t.inputChangeHandler=function(e){return e.length<oe?z():0===e.length&&0===oe?(t.searching=!1,Q()):(Y(),se&&l.cancel(se),t.searching=!0,se=l(function(){K(t.searchStr)},t.pause)),t.inputChanged&&(e=t.inputChanged(e)),e},t.fieldRequiredClass&&""!==t.fieldRequiredClass&&(ae=t.fieldRequiredClass),t.minlength&&""!==t.minlength&&(oe=parseInt(t.minlength,10)),t.pause||(t.pause=f),t.clearSelected||(t.clearSelected=!1),t.overrideSuggestions||(t.overrideSuggestions=!1),t.fieldRequired&&C&&O(t.initialValue?!0:!1),t.inputType=x.type?x.type:"text",t.textSearching=x.textSearching?x.textSearching:S,t.textNoResults=x.textNoResults?x.textNoResults:w,t.maxlength=x.maxlength?x.maxlength:p,ie?(te=le.on("keydown",L),ne=le.on("keyup",U)):(t.keydownHandler=L,t.keyupHandler=U),Z=b("remoteUrlResponseFormatter"),t.$on("$destroy",function(){O(!0),ie&&(le.off(te),le.off(ne),le.off(re))}),l(function(){var e=getComputedStyle(de);ge=e.maxHeight&&"auto"===e.overflowY})}}}])});